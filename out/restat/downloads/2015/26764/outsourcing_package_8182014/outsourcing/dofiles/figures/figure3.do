global x "$masterpath/datafiles/"
global y "$masterpath/trade/"
global z "$masterpath/outfiles/"

# delimit ;

capture log close;
clear;
set mem 1400m;
set more off;
set matsize 800;

*use ${x}table6_norpiship.dta;

*keep if year==1984|year==1985|year==2001|year==2002;

*xi I.year I.educ I.occ8090;

*keep lwage p_llowincemp_effective_occ p_lhigh_effective_occ p_expmod_effective_occ p_penmod_effective_occ age female union exper nonwhite year _Iyear* _Ieduc* _Iocc8090* ihwt occ8090;

use table6_norpiship_small_occ.dta, replace;

log using figure3.log, replace;
*****************;
* 1984 and 1985 *;
*****************;
reg lwage p_llowincemp_effective_occ p_lhigh_effective_occ p_expmod_effective_occ p_penmod_effective_occ age female union exper nonwhite _Iyear* _Ieduc* _Iocc8090* if year==1984|year==1985 [weight=ihwt], robust cluster(occ8090);

global numlist "4 5 6 7 8 9 13 14 15 16 17 18 19 23 24 25 26 27 28 29 33 34 35 36 37 43 44 45 46 47 48 49 53 54 55 56 57 58 59 63 64 65 66 67 68 69 73 74 75 76 77 78 79 83 84 85 86 87 88 89 95 96 97 98 99 103 104 105 106 113 114 115 116 117 118 119 123 124 125 126 127 128 129 133 134 135 136 137 138 139 143 144 145 146 147 148 149 153 154 155 156 157 158 159 163 164 165 166 167 168 169 173 174 175 176 177 178 179 183 184 185 186 187 188 189 193 194 195 197 198 199 203 204 205 206 207 213 214 215 216 217 223 224 225 226 227 228 229 233 234 235 243 253 254 255 256 257 258 259 263 264 265 266 267 268 269 274 275 276 277 278 283 284 285 303 304 305 306 307 308 309 313 314 315 316 317 319 323 325 326 327 328 329 335 336 337 338 339 343 344 345 346 347 348 353 354 355 356 357 359 363 364 365 366 368 373 374 375 376 377 378 379 383 384 385 386 387 389 404 405 406 407 413 414 415 416 417 418 423 424 425 426 427 433 434 435 436 438 439 443 444 445 446 447 448 449 453 454 455 456 457 458 459 463 464 465 466 467 468 469 473 474 475 476 477 479 483 484 485 486 487 488 489 494 495 496 497 498 503 505 506 507 508 509 514 515 516 517 518 519 523 525 526 527 529 533 534 535 536 538 539 543 544 547 549 553 554 555 556 557 558 563 564 565 566 567 569 573 575 576 577 579 583 584 585 587 588 589 593 594 595 596 597 598 599 613 614 615 616 617 633 634 635 636 637 639 643 644 645 646 647 649 653 654 655 656 657 658 659 666 667 668 669 674 675 676 677 678 679 683 684 686 687 688 689 693 694 695 699 703 704 705 706 707 708 709 713 714 715 717 719 723 724 725 726 727 728 729 733 734 735 736 737 738 739 743 744 745 747 748 749 753 754 755 756 757 758 759 763 764 765 766 768 769 773 774 777 779 783 784 785 786 787 789 793 795 796 797 798 799 803 804 806 808 809 813 814 823 824 825 826 828 829 833 834 843 844 845 848 849 853 855 856 859 863 864 865 866 867 869 873 875 876 878 883 885 887 888 889";

foreach j of global numlist{ ;
	gen m`j'=_b[_Iocc8090_`j'];
};

egen mean8485=rowmean(m4 m5 m6 m7 m8 m9 m13 m14 m15 m16 m17 m18 m19 m23 m24 m25 m26 m27 m28 m29 m33 m34 m35 m36 m37 m43 m44 m45 m46 m47 m48 m49 m53 m54 m55 m56 m57 m58 m59 m63 m64 m65 m66 m67 m68 m69 m73 m74 m75 m76 m77 m78 m79 m83 m84 m85 m86 m87 m88 m89 m95 m96 m97 m98 m99 m103 m104 m105 m106 m113 m114 m115 m116 m117 m118 m119 m123 m124 m125 m126 m127 m128 m129 m133 m134 m135 m136 m137 m138 m139 m143 m144 m145 m146 m147 m148 m149 m153 m154 m155 m156 m157 m158 m159 m163 m164 m165 m166 m167 m168 m169 m173 m174 m175 m176 m177 m178 m179 m183 m184 m185 m186 m187 m188 m189 m193 m194 m195 m197 m198 m199 m203 m204 m205 m206 m207 m213 m214 m215 m216 m217 m223 m224 m225 m226 m227 m228 m229 m233 m234 m235 m243 m253 m254 m255 m256 m257 m258 m259 m263 m264 m265 m266 m267 m268 m269 m274 m275 m276 m277 m278 m283 m284 m285 m303 m304 m305 m306 m307 m308 m309 m313 m314 m315 m316 m317 m319 m323 m325 m326 m327 m328 m329 m335 m336 m337 m338 m339 m343 m344 m345 m346 m347 m348 m353 m354 m355 m356 m357 m359 m363 m364 m365 m366 m368 m373 m374 m375 m376 m377 m378 m379 m383 m384 m385 m386 m387 m389 m404 m405 m406 m407 m413 m414 m415 m416 m417 m418 m423 m424 m425 m426 m427 m433 m434 m435 m436 m438 m439 m443 m444 m445 m446 m447 m448 m449 m453 m454 m455 m456 m457 m458 m459 m463 m464 m465 m466 m467 m468 m469 m473 m474 m475 m476 m477 m479 m483 m484 m485 m486 m487 m488 m489 m494 m495 m496 m497 m498 m503 m505 m506 m507 m508 m509 m514 m515 m516 m517 m518 m519 m523 m525 m526 m527 m529 m533 m534 m535 m536 m538 m539 m543 m544 m547 m549 m553 m554 m555 m556 m557 m558 m563 m564 m565 m566 m567 m569 m573 m575 m576 m577 m579 m583 m584 m585 m587 m588 m589 m593 m594 m595 m596 m597 m598 m599 m613 m614 m615 m616 m617 m633 m634 m635 m636 m637 m639 m643 m644 m645 m646 m647 m649 m653 m654 m655 m656 m657 m658 m659 m666 m667 m668 m669 m674 m675 m676 m677 m678 m679 m683 m684 m686 m687 m688 m689 m693 m694 m695 m699 m703 m704 m705 m706 m707 m708 m709 m713 m714 m715 m717 m719 m723 m724 m725 m726 m727 m728 m729 m733 m734 m735 m736 m737 m738 m739 m743 m744 m745 m747 m748 m749 m753 m754 m755 m756 m757 m758 m759 m763 m764 m765 m766 m768 m769 m773 m774 m777 m779 m783 m784 m785 m786 m787 m789 m793 m795 m796 m797 m798 m799 m803 m804 m806 m808 m809 m813 m814 m823 m824 m825 m826 m828 m829 m833 m834 m843 m844 m845 m848 m849 m853 m855 m856 m859 m863 m864 m865 m866 m867 m869 m873 m875 m876 m878 m883 m885 m887 m888 m889);

foreach j of global numlist{ ;
	gen dev`j'_8485=m`j'-mean8485;
};
drop m*;

*****************;
* 2001 and 2002 *;
*****************;
reg lwage p_llowincemp_effective_occ p_lhigh_effective_occ p_expmod_effective_occ p_penmod_effective_occ age female union exper nonwhite _Iyear* _Ieduc* _Iocc8090* if year==2001|year==2002 [weight=ihwt], robust cluster(occ8090);

bysort occ8090: keep if _n==1;

foreach j of global numlist{ ;
	gen n`j'=_b[_Iocc8090_`j'];
};

egen mean0102=rowmean(n4 n5 n6 n7 n8 n9 n13 n14 n15 n16 n18 n19 n23 n24 n25 n26 n27 n28 n29 n33 n34 n35 n36 n37 n43 n44 n45 n46 n47 n48 n49 n53 n54 n55 n56 n57 n58 n59 n63 n64 n65 n66 n67 n68 n69 n73 n74 n75 n76 n77 n78 n79 n83 n84 n85 n86 n87 n88 n89 n95 n96 n97 n98 n99 n103 n104 n105 n106 n113 n114 n115 n116 n117 n118 n119 n123 n124 n125 n126 n127 n128 n129 n133 n134 n135 n136 n137 n138 n139 n143 n144 n145 n146 n147 n148 n153 n154 n155 n156 n157 n158 n159 n163 n164 n165 n166 n167 n168 n169 n173 n174 n175 n176 n177 n178 n183 n184 n185 n186 n187 n188 n189 n193 n194 n195 n197 n198 n199 n203 n204 n205 n206 n207 n213 n214 n215 n216 n217 n223 n224 n225 n226 n227 n228 n229 n233 n234 n235 n243 n253 n254 n255 n256 n257 n258 n259 n263 n264 n265 n266 n267 n268 n269 n274 n275 n276 n277 n278 n283 n284 n285 n303 n304 n305 n306 n307 n308 n309 n313 n314 n315 n316 n317 n319 n323 n325 n326 n327 n328 n329 n335 n336 n337 n338 n339 n343 n344 n345 n346 n347 n348 n353 n354 n355 n356 n357 n359 n363 n364 n365 n366 n368 n373 n374 n375 n376 n377 n378 n379 n383 n384 n385 n386 n387 n389 n404 n405 n406 n407 n413 n414 n415 n416 n417 n418 n423 n424 n425 n426 n427 n433 n434 n435 n436 n438 n439 n443 n444 n445 n446 n447 n448 n449 n453 n454 n455 n456 n457 n458 n459 n463 n464 n465 n466 n467 n468 n469 n473 n474 n475 n476 n477 n479 n483 n484 n485 n486 n487 n488 n489 n494 n495 n496 n497 n498 n503 n505 n506 n507 n508 n509 n514 n515 n516 n517 n518 n519 n523 n525 n526 n527 n529 n533 n534 n535 n536 n538 n539 n543 n544 n547 n549 n553 n554 n555 n556 n557 n558 n563 n564 n565 n566 n567 n569 n573 n575 n576 n577 n579 n583 n584 n585 n587 n588 n589 n593 n594 n595 n596 n597 n598 n599 n613 n614 n615 n616 n617 n633 n634 n635 n636 n637 n639 n643 n644 n645 n646 n647 n649 n653 n654 n655 n656 n657 n658 n659 n666 n667 n668 n669 n674 n675 n676 n677 n678 n679 n683 n684 n686 n687 n688 n689 n693 n694 n695 n699 n703 n704 n705 n706 n707 n708 n709 n713 n714 n715 n717 n719 n723 n724 n725 n726 n727 n728 n729 n733 n734 n735 n736 n737 n738 n739 n743 n744 n745 n747 n748 n749 n753 n754 n755 n756 n757 n758 n759 n763 n764 n765 n766 n768 n769 n773 n774 n777 n779 n783 n784 n785 n786 n787 n789 n793 n795 n796 n797 n798 n799 n803 n804 n806 n808 n809 n813 n814 n823 n824 n825 n826 n828 n829 n833 n834 n843 n844 n845 n848 n849 n853 n855 n856 n859 n863 n864 n865 n866 n867 n869 n873 n875 n876 n878 n883 n885 n887 n888 n889);

foreach j of global numlist{ ;
	gen dev`j'_0102=n`j'-mean0102;
	drop n`j';
};


keep occ8090 dev*_8485 dev*_0102;

gen dev_8485=.;
gen dev_0102=.;
foreach j of global numlist {;
	replace dev_8485=dev`j'_8485 if occ8090==`j'; 
	replace dev_0102=dev`j'_0102 if occ8090==`j';
};

drop if dev_8485==. & dev_0102==.;

keep occ8090 dev_8485 dev_0102; 

twoway scatter dev_8485 dev_0102, subtitle("Occupation-Specific Wage Differentials") ytitle("1984 and 1985") ylabel(#3, labsize(small)) xtitle("2001 and 2002") scheme(sj) ;

log close;
exit;
