#delim;
qui {;
set more off;
pause on;
clear;
set mem 200m;
/*Aug-25-2010*/ 
/*decomp 2's (modified BBH) between term*/

/*%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%*/
* N.B.: THIS FILE SHOULD BE RUN ONCE DC1 IS GENERATED BY gen_decomp.do;
* LOCAL VARIABLE thisrun SHOULD BE RENAMED ACCORDINGLY SINCE;
* THE COMPONENTS OF DC1 ARE STORED BY dc1_final.dta IN A DIRECTORY UNDER THE NAME OF THE RUN;

local thisrun = "run1";
local resultdir = "$path1"+"result_"+"`thisrun'\";

/*%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%*/

global path1    ="~\"; /*current directory*/
global temppath ="$path1"+"temp";

global id      = "id";
global yr      = "yr";
global ind     = "ind";

global cov "cov";
global covi "cov_i";
global cov_f "cov_f";
global covi_f "cov_i_f";

use "$path1\dc_workfile", clear;

/*four shares, four aggr lntaus*/;
/*between term*/
local shlist  "_o _i _f _i_f";
local covlist "_o _i _f _i_f";
local namelist3 "";
local stringindicator "";

foreach x of local shlist {;
	if "`x'"=="_o"{;
		local sh "";
		local shsuff "d";
		};
	else if "`x'"=="_i"{;
		local sh "`x'";
		local shsuff ="i";
		};
	else if "`x'"=="_f"{;
		local sh "`x'";
		local shsuff ="f";
		};
	else {;
		local sh "`x'";
		local shsuff ="if";
		};
	local vname1  ="b1"+"`sh'";
	local phiname ="phi"+"`sh'";
	sort $id $yr;
	gen `vname1'= (`phiname' - L.`phiname')	if C==1;
	replace `vname1' = 0 if C!=1;
	foreach y of local covlist {;
		local dt "`y'";
		if "`y'"=="_o"{;
			local covsuff ="_cd";
			local dt "";
			};
		else if "`y'"=="_i"{;
			local covsuff ="_ci";
			local dt "`y'";
			};
		else if "`y'"=="_f"{;
			local covsuff ="_cf";
			local dt "`y'";
			};
		else {;
			local covsuff ="_cif";
			local dt "`y'";
			};
		/*** cov terms ***/
		local Lcovname = "Lcov"+"`dt'";
		local covname  = "cov"+"`dt'";
		local vname21  = "b21"+"`shsuff'"+"`covsuff'";
		local vname22  = "b22"+"`shsuff'"+"`covsuff'";
		sort $id $yr;
		gen `vname21' = `vname1' *((lntau+L.lntau)/2 - (lntau_m+L.lntau_m)/2);
		gen `vname22' = `vname1' *(`covname'+L.`covname')/2 ;
		*by touse $ind $yr, sort: egen v1 = total(`vname21') if touse==1 & C==1;
		*by touse $ind $yr, sort: egen v2 = total(`vname22') if touse==1 & C==1;
		 by touse      $yr, sort: egen v1 = total(`vname21') if touse==1 & C==1;
		 by touse      $yr, sort: egen v2 = total(`vname22') if touse==1 & C==1;

		local vname31 = "dc2_1"+"_s"+"`shsuff'"+"`covsuff'";
		local vname32 = "dc2_2"+"_s"+"`shsuff'"+"`covsuff'";
		sort $id $yr;
		rename v1 `vname31';
		rename v2 `vname32';

		/*when string gets too long start another one (namelist31)*/
		scalar ss=0;
		if "`vname32'"=="dc2_2_si_cif"{;
			local stringindicator="now";
			local namelist33 = "`namelist3'";
		};

		if "`stringindicator'"==""{;
			local namelist3 = "`namelist3'"+" `vname31' `vname32'";
			};
		else {;
			local namelist31="`namelist31'"+" `vname31' `vname32'";
			};

		drop `vname21';
		drop `vname22';
		*noi di "`vname31'";
		*noi di "`vname32'";
	};
	drop `vname1';
};
noi di in yellow "between term of dc2 done";
*noi di "`namelist33'"; 
*noi di "`namelist31'"; 

global aggrlist1 "$cov	$covi $cov_f $covi_f lntau_m";
global aggrlist2 "	`namelist33'";
global aggrlist3 "	`namelist31'";

global merglist1 "$cov	$covi $cov_f $covi_f lntau_m";
global merglist2 "	`namelist33'";
global merglist3 "	`namelist31'";

global firstword = word("$aggrlist1",1);
save "$path1\dc2_workfile", replace;

noi run "$path1\gen_decomp_betw2_2.do";

save "`resultdir'\dc2_final", replace;
sort $ind $yr;

use "`resultdir'\dc1_final", clear;
merge $ind $yr using "`resultdir'\dc2_final"; noi tab _merge; drop _merge;
save "`resultdir'\dc1_2_final_merged", replace;

macro drop _all; matrix drop _all; scalar drop _all;
*log close;

}; /*end of main qui block*/;
