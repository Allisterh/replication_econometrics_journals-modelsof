[
  {
    "id": "comment",
    "value": "*****************************",
    "line": 1,
    "column": 1
  },
  {
    "id": "comment",
    "value": "* DOES PLANNING REGULATION PROTECT INDEPENDENT RETAILERS?",
    "line": 2,
    "column": 1
  },
  {
    "id": "comment",
    "value": "* Do file to prepare retail panel at the firm and local authority level",
    "line": 3,
    "column": 1
  },
  {
    "id": "comment",
    "value": "* Created by Raffaella Sadun (rsadun@hbs.edu)",
    "line": 4,
    "column": 1
  },
  {
    "id": "comment",
    "value": "*****************************",
    "line": 5,
    "column": 1
  },
  {
    "command": {
      "id": "identifier",
      "value": "clear",
      "line": 6,
      "column": 1
    }
  },
  {
    "command": {
      "id": "identifier",
      "value": "set",
      "line": 7,
      "column": 1
    },
    "varlist": [
      {
        "id": "identifier",
        "value": "mem",
        "line": 7,
        "column": 5
      },
      {
        "id": "number",
        "value": "1000m",
        "line": 7,
        "column": 9
      }
    ]
  },
  {
    "command": {
      "id": "identifier",
      "value": "adopath",
      "line": 8,
      "column": 1
    },
    "varlist": [
      {
        "id": "+",
        "value": "+",
        "line": 8,
        "column": 9
      },
      {
        "id": "+",
        "value": "+",
        "line": 8,
        "column": 10
      },
      {
        "id": "string",
        "value": "\"t:\\ceriba\\stata_files\\ado\\stb\\\"",
        "line": 8,
        "column": 11
      }
    ]
  },
  {
    "id": "comment",
    "value": "/*\n* First run with files in ard2 (last version of ard)\n/* 1. Put all retail local units together */",
    "line": 12,
    "column": 1
  },
  {
    "command": {
      "id": "identifier",
      "value": "forvalues",
      "line": 13,
      "column": 1
    },
    "varlist": [
      {
        "id": "identifier",
        "value": "x",
        "line": 13,
        "column": 11
      }
    ],
    "=": [
      {
        "id": "number",
        "value": "1997",
        "line": 13,
        "column": 13
      },
      {
        "id": "number",
        "value": "1",
        "line": 13,
        "column": 18
      },
      {
        "id": "number",
        "value": "2004",
        "line": 13,
        "column": 20
      },
      {
        "id": "{",
        "value": "{",
        "line": 13,
        "column": 25
      }
    ]
  },
  {
    "command": {
      "id": "identifier",
      "value": "foreach",
      "line": 14,
      "column": 1
    },
    "varlist": [
      {
        "id": "identifier",
        "value": "ru",
        "line": 14,
        "column": 9
      }
    ],
    "in": [
      {
        "id": "identifier",
        "value": "snul",
        "line": 14,
        "column": 15
      },
      {
        "id": "{",
        "value": "{",
        "line": 14,
        "column": 20
      }
    ]
  },
  {
    "command": {
      "id": "identifier",
      "value": "use",
      "line": 15,
      "column": 1
    },
    "varlist": [
      {
        "id": "string",
        "value": "\"U:\\ARD2\\\\`ru'`x'reg.dta\"",
        "line": 15,
        "column": 5
      }
    ],
    "options": [
      {
        "id": "identifier",
        "value": "clear",
        "line": 15,
        "column": 32
      }
    ]
  },
  {
    "command": {
      "id": "identifier",
      "value": "keep",
      "line": 16,
      "column": 1
    },
    "varlist": [
      {
        "id": "identifier",
        "value": "ruref",
        "line": 16,
        "column": 6
      },
      {
        "id": "identifier",
        "value": "luref",
        "line": 16,
        "column": 12
      },
      {
        "id": "identifier",
        "value": "year",
        "line": 16,
        "column": 18
      },
      {
        "id": "identifier",
        "value": "empment",
        "line": 16,
        "column": 23
      },
      {
        "id": "identifier",
        "value": "region",
        "line": 16,
        "column": 31
      },
      {
        "id": "identifier",
        "value": "sic92",
        "line": 16,
        "column": 38
      },
      {
        "id": "identifier",
        "value": "district",
        "line": 16,
        "column": 44
      },
      {
        "id": "identifier",
        "value": "county",
        "line": 16,
        "column": 53
      },
      {
        "id": "identifier",
        "value": "postcode",
        "line": 16,
        "column": 61
      }
    ]
  },
  {
    "command": {
      "id": "identifier",
      "value": "destring",
      "line": 17,
      "column": 1
    },
    "varlist": [
      {
        "id": "identifier",
        "value": "ruref",
        "line": 17,
        "column": 11
      }
    ],
    "options": [
      {
        "id": "identifier",
        "value": "replace",
        "line": 17,
        "column": 18
      }
    ]
  },
  {
    "command": {
      "id": "identifier",
      "value": "gen",
      "line": 18,
      "column": 1
    },
    "varlist": [
      {
        "id": "identifier",
        "value": "luref_n",
        "line": 18,
        "column": 5
      }
    ],
    "=": [
      {
        "id": "identifier",
        "value": "substr",
        "line": 18,
        "column": 16
      },
      {
        "id": "identifier",
        "value": "luref",
        "line": 18,
        "column": 23
      },
      {
        "id": ",",
        "value": ",",
        "line": 18,
        "column": 28
      },
      {
        "id": "number",
        "value": "1",
        "line": 18,
        "column": 29
      },
      {
        "id": ",",
        "value": ",",
        "line": 18,
        "column": 30
      },
      {
        "id": "number",
        "value": "1",
        "line": 18,
        "column": 31
      }
    ]
  },
  {
    "command": {
      "id": "identifier",
      "value": "gen",
      "line": 19,
      "column": 1
    },
    "varlist": [
      {
        "id": "identifier",
        "value": "luref_n2",
        "line": 19,
        "column": 5
      }
    ],
    "=": [
      {
        "id": "identifier",
        "value": "substr",
        "line": 19,
        "column": 17
      },
      {
        "id": "identifier",
        "value": "luref",
        "line": 19,
        "column": 24
      },
      {
        "id": ",",
        "value": ",",
        "line": 19,
        "column": 29
      },
      {
        "id": "number",
        "value": "2",
        "line": 19,
        "column": 30
      },
      {
        "id": ",",
        "value": ",",
        "line": 19,
        "column": 31
      },
      {
        "id": "identifier",
        "value": ".",
        "line": 19,
        "column": 32
      }
    ]
  },
  {
    "command": {
      "id": "identifier",
      "value": "replace",
      "line": 20,
      "column": 1
    },
    "varlist": [
      {
        "id": "identifier",
        "value": "luref",
        "line": 20,
        "column": 9
      }
    ],
    "=": [
      {
        "id": "identifier",
        "value": "luref_n2",
        "line": 20,
        "column": 17
      }
    ],
    "if": [
      {
        "id": "identifier",
        "value": "luref_n",
        "line": 20,
        "column": 29
      },
      {
        "id": "==",
        "value": "==",
        "line": 20,
        "column": 36
      },
      {
        "id": "string",
        "value": "\"X\"",
        "line": 20,
        "column": 38
      }
    ]
  },
  {
    "command": {
      "id": "identifier",
      "value": "destring",
      "line": 21,
      "column": 1
    },
    "varlist": [
      {
        "id": "identifier",
        "value": "luref",
        "line": 21,
        "column": 11
      }
    ],
    "options": [
      {
        "id": "identifier",
        "value": "replace",
        "line": 21,
        "column": 18
      }
    ]
  },
  {
    "command": {
      "id": "identifier",
      "value": "gen",
      "line": 22,
      "column": 1
    },
    "varlist": [
      {
        "id": "identifier",
        "value": "local",
        "line": 22,
        "column": 5
      }
    ],
    "=": [
      {
        "id": "number",
        "value": "1",
        "line": 22,
        "column": 11
      }
    ]
  },
  {
    "command": {
      "id": "identifier",
      "value": "rename",
      "line": 23,
      "column": 1
    },
    "varlist": [
      {
        "id": "identifier",
        "value": "empment",
        "line": 23,
        "column": 8
      },
      {
        "id": "identifier",
        "value": "emp_lu",
        "line": 23,
        "column": 16
      }
    ]
  },
  {
    "command": {
      "id": "identifier",
      "value": "rename",
      "line": 24,
      "column": 1
    },
    "varlist": [
      {
        "id": "identifier",
        "value": "sic92",
        "line": 24,
        "column": 8
      },
      {
        "id": "identifier",
        "value": "sic_lu",
        "line": 24,
        "column": 14
      }
    ]
  },
  {
    "command": {
      "id": "identifier",
      "value": "destring",
      "line": 25,
      "column": 1
    },
    "varlist": [
      {
        "id": "identifier",
        "value": "sic_lu",
        "line": 25,
        "column": 10
      }
    ],
    "options": [
      {
        "id": "identifier",
        "value": "replace",
        "line": 25,
        "column": 18
      }
    ]
  },
  {
    "command": {
      "id": "identifier",
      "value": "so",
      "line": 26,
      "column": 1
    },
    "varlist": [
      {
        "id": "identifier",
        "value": "ruref",
        "line": 26,
        "column": 4
      },
      {
        "id": "identifier",
        "value": "year",
        "line": 26,
        "column": 10
      }
    ]
  },
  {
    "command": {
      "id": "identifier",
      "value": "save",
      "line": 27,
      "column": 1
    },
    "varlist": [
      {
        "id": "string",
        "value": "\"H:\\Raffaella\\Retail\\Data\\\\`ru'`x'_reg_ard2\"",
        "line": 27,
        "column": 6
      }
    ],
    "options": [
      {
        "id": "identifier",
        "value": "replace",
        "line": 27,
        "column": 52
      }
    ]
  },
  {
    "command": {
      "id": "identifier",
      "value": "clear",
      "line": 32,
      "column": 1
    }
  },
  {
    "command": {
      "id": "identifier",
      "value": "set",
      "line": 33,
      "column": 1
    },
    "varlist": [
      {
        "id": "identifier",
        "value": "mem",
        "line": 33,
        "column": 5
      },
      {
        "id": "number",
        "value": "500m",
        "line": 33,
        "column": 9
      }
    ]
  },
  {
    "command": {
      "id": "identifier",
      "value": "ge",
      "line": 34,
      "column": 1
    },
    "varlist": [
      {
        "id": "identifier",
        "value": "temp",
        "line": 34,
        "column": 4
      }
    ],
    "=": [
      {
        "id": "identifier",
        "value": ".",
        "line": 34,
        "column": 9
      }
    ]
  },
  {
    "command": {
      "id": "identifier",
      "value": "forvalues",
      "line": 35,
      "column": 1
    },
    "varlist": [
      {
        "id": "identifier",
        "value": "x",
        "line": 35,
        "column": 11
      }
    ],
    "=": [
      {
        "id": "number",
        "value": "1997",
        "line": 35,
        "column": 13
      },
      {
        "id": "number",
        "value": "1",
        "line": 35,
        "column": 18
      },
      {
        "id": "number",
        "value": "2004",
        "line": 35,
        "column": 20
      },
      {
        "id": "{",
        "value": "{",
        "line": 35,
        "column": 25
      }
    ]
  },
  {
    "command": {
      "id": "identifier",
      "value": "foreach",
      "line": 36,
      "column": 1
    },
    "varlist": [
      {
        "id": "identifier",
        "value": "ru",
        "line": 36,
        "column": 9
      }
    ],
    "in": [
      {
        "id": "identifier",
        "value": "snul",
        "line": 36,
        "column": 15
      },
      {
        "id": "{",
        "value": "{",
        "line": 36,
        "column": 20
      }
    ]
  },
  {
    "command": {
      "id": "identifier",
      "value": "append",
      "line": 37,
      "column": 1
    },
    "varlist": [
      {
        "id": "identifier",
        "value": "using",
        "line": 37,
        "column": 8
      },
      {
        "id": "string",
        "value": "\"H:\\Raffaella\\Retail\\Data\\\\snul`x'_reg_ard2\n}\n}\nso luref year\ndrop if luref==luref[_n-1] & year==year[_n-1]\ndrop if luref==luref[_n+1] & year==year[_n+1]\nsave \"",
        "line": 37,
        "column": 14
      },
      {
        "id": "identifier",
        "value": "H",
        "line": 37,
        "column": 174
      },
      {
        "id": ":",
        "value": ":",
        "line": 37,
        "column": 175
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 176
      },
      {
        "id": "identifier",
        "value": "Raffaella",
        "line": 37,
        "column": 177
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 186
      },
      {
        "id": "identifier",
        "value": "Retail",
        "line": 37,
        "column": 187
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 193
      },
      {
        "id": "identifier",
        "value": "Data",
        "line": 37,
        "column": 194
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 198
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 199
      },
      {
        "id": "identifier",
        "value": "snul_all_years_reg_ard2",
        "line": 37,
        "column": 200
      },
      {
        "id": "string",
        "value": "\", replace\n\n\n******************************\n* ENTRY AND EXIT\n******************************\nclear\nset mem 1000m\nuse \"",
        "line": 37,
        "column": 223
      },
      {
        "id": "identifier",
        "value": "H",
        "line": 37,
        "column": 340
      },
      {
        "id": ":",
        "value": ":",
        "line": 37,
        "column": 341
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 342
      },
      {
        "id": "identifier",
        "value": "Raffaella",
        "line": 37,
        "column": 343
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 352
      },
      {
        "id": "identifier",
        "value": "Retail",
        "line": 37,
        "column": 353
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 359
      },
      {
        "id": "identifier",
        "value": "Data",
        "line": 37,
        "column": 360
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 364
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 365
      },
      {
        "id": "identifier",
        "value": "snul_all_years_reg_ard2",
        "line": 37,
        "column": 366
      },
      {
        "id": "string",
        "value": "\", clear\nbys luref: egen mode_r=mode(region), minmode\n* Note: assigning lurefs to modal region\nreplace region=mode_r\nso region\nmerge region using \"",
        "line": 37,
        "column": 389
      },
      {
        "id": "identifier",
        "value": "H",
        "line": 37,
        "column": 536
      },
      {
        "id": ":",
        "value": ":",
        "line": 37,
        "column": 537
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 538
      },
      {
        "id": "identifier",
        "value": "Raffaella",
        "line": 37,
        "column": 539
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 548
      },
      {
        "id": "identifier",
        "value": "Retail",
        "line": 37,
        "column": 549
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 555
      },
      {
        "id": "identifier",
        "value": "Data",
        "line": 37,
        "column": 556
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 560
      },
      {
        "id": "identifier",
        "value": "reg_code.dta",
        "line": 37,
        "column": 561
      },
      {
        "id": "string",
        "value": "\" \ndrop if _m==2\ndrop _m\nsave \"",
        "line": 37,
        "column": 573
      },
      {
        "id": "identifier",
        "value": "H",
        "line": 37,
        "column": 604
      },
      {
        "id": ":",
        "value": ":",
        "line": 37,
        "column": 605
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 606
      },
      {
        "id": "identifier",
        "value": "Raffaella",
        "line": 37,
        "column": 607
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 616
      },
      {
        "id": "identifier",
        "value": "Retail",
        "line": 37,
        "column": 617
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 623
      },
      {
        "id": "identifier",
        "value": "Data",
        "line": 37,
        "column": 624
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 628
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 629
      },
      {
        "id": "identifier",
        "value": "snul_all_years_reg1_ard2",
        "line": 37,
        "column": 630
      },
      {
        "id": "string",
        "value": "\", replace\n\nuse \"",
        "line": 37,
        "column": 654
      },
      {
        "id": "identifier",
        "value": "H",
        "line": 37,
        "column": 671
      },
      {
        "id": ":",
        "value": ":",
        "line": 37,
        "column": 672
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 673
      },
      {
        "id": "identifier",
        "value": "Raffaella",
        "line": 37,
        "column": 674
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 683
      },
      {
        "id": "identifier",
        "value": "Retail",
        "line": 37,
        "column": 684
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 690
      },
      {
        "id": "identifier",
        "value": "Data",
        "line": 37,
        "column": 691
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 695
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 696
      },
      {
        "id": "identifier",
        "value": "snul_all_years_reg1_ard2",
        "line": 37,
        "column": 697
      },
      {
        "id": "string",
        "value": "\", replace\n* Some local units change postcode over time, fix it\nbys luref: egen m_postcode=mode(postcode), maxmode\nreplace postcode=m_postcode\n\n* Just before identifiying entry, correct for spurious changes in luref code where possible\n* Count lurefs per ruref and postcode\nbys ruref year postcode: egen ru_pcode_year=count(luref)\n\n* Note: some lurefs belong to more than one ruref in their history\negen g_r=group(ruref)\nbys luref: egen m_ru=mean(g_r)\nge change_ruref=(ruref~=m_ru)\ncap drop p1 m_p1 m_luref luref2\n\n* Note: this problem of changing luref, same postcode is linked to lurefs that at some point change the reporting unit\nso ruref postcode year\nbys ruref postcode: ge p1=(ru_pcode==1 & postc==postc[_n-1]&luref~=luref[_n-1] & ruref==ruref[_n-1] & year~=1997)\nbys ruref postcode: egen m_p1=max(p1) if ru_pcode==1\nbys ruref postcode: egen double m_luref=mode(luref) if m_p1==1, minmode\n\ncap drop luref2\nge double luref2=luref\nreplace luref2=m_luref if m_p1==1 & ru_pcode==1\nsave \"",
        "line": 37,
        "column": 721
      },
      {
        "id": "identifier",
        "value": "H",
        "line": 37,
        "column": 1711
      },
      {
        "id": ":",
        "value": ":",
        "line": 37,
        "column": 1712
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 1713
      },
      {
        "id": "identifier",
        "value": "Raffaella",
        "line": 37,
        "column": 1714
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 1723
      },
      {
        "id": "identifier",
        "value": "Retail",
        "line": 37,
        "column": 1724
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 1730
      },
      {
        "id": "identifier",
        "value": "Data",
        "line": 37,
        "column": 1731
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 1735
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 1736
      },
      {
        "id": "identifier",
        "value": "snul_all_years_reg2_ard2",
        "line": 37,
        "column": 1737
      },
      {
        "id": "string",
        "value": "\", replace\n\n\nuse \"",
        "line": 37,
        "column": 1761
      },
      {
        "id": "identifier",
        "value": "H",
        "line": 37,
        "column": 1779
      },
      {
        "id": ":",
        "value": ":",
        "line": 37,
        "column": 1780
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 1781
      },
      {
        "id": "identifier",
        "value": "Raffaella",
        "line": 37,
        "column": 1782
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 1791
      },
      {
        "id": "identifier",
        "value": "Retail",
        "line": 37,
        "column": 1792
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 1798
      },
      {
        "id": "identifier",
        "value": "Data",
        "line": 37,
        "column": 1799
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 1803
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 1804
      },
      {
        "id": "identifier",
        "value": "snul_all_years_reg2_ard2",
        "line": 37,
        "column": 1805
      },
      {
        "id": "string",
        "value": "\", replace\n* This generates some duplicates. If that is the case, drop the shop beacuse its coding is dodgy\nso luref2 year\nge p0=(luref2==luref2[_n-1] & year==year[_n-1])\nbys luref2 year: egen m_p0=max(p0)\nbys luref2: egen double m_ruref=mode(g_r), maxmode\ndrop if m_p0==1 & g_r~=m_ruref\nreplace luref=luref2 if m_p1==1\n\n\nbysort luref (year): gen yd = year[_n+1] - year\nexpand yd\nsort luref year\n\n* Note: code imputed values as missings\nge imputed=(year==year[_n-1] & luref==luref[_n-1])\nbysort luref year: replace year=year + _n-1\n\n* Example of what I want to do\n*so ruref postcode year\n*li ruref luref* postcode year  m_luref p1 if ru_pcode==1 & ruref==50000035288\ndrop luref_n luref_n2  m_luref luref2\n\n\nso luref year\nby luref: gen exit=2 if year~=year[_n-1]+1 \n* Exitors\nby luref: replace exit=3 if year~=year[_n+1]-1 \n* 1 Year: Note, not possible to distinguish for 2003 and 1997\nby luref: replace exit=4 if year~=year[_n-1]+1 & year~=year[_n+1]-1 \n* Stayers\nreplace exit =1 if exit==.\nreplace exit=. if (year==1997 |  year==2004) \n*ta year imputed\nreplace emp_lu=. if imputed==1\n\n\n/* Foreign Ownership\nreplace ultfoc=\"",
        "line": 37,
        "column": 1829
      },
      {
        "id": "number",
        "value": "783",
        "line": 37,
        "column": 2953
      },
      {
        "id": "string",
        "value": "\" if ultfoc==\"",
        "line": 37,
        "column": 2956
      },
      {
        "id": "number",
        "value": "000",
        "line": 37,
        "column": 2970
      },
      {
        "id": "string",
        "value": "\" | ultfoc==\"",
        "line": 37,
        "column": 2973
      },
      {
        "id": "identifier",
        "value": "AAA",
        "line": 37,
        "column": 2986
      },
      {
        "id": "string",
        "value": "\" | ultfoc==\"",
        "line": 37,
        "column": 2989
      },
      {
        "id": "number",
        "value": "826",
        "line": 37,
        "column": 3002
      },
      {
        "id": "string",
        "value": "\" \nreplace ultfoc=\"",
        "line": 37,
        "column": 3005
      },
      {
        "id": "number",
        "value": "805",
        "line": 37,
        "column": 3024
      },
      {
        "id": "string",
        "value": "\" if ultfoc==\"",
        "line": 37,
        "column": 3027
      },
      {
        "id": "number",
        "value": "840",
        "line": 37,
        "column": 3041
      },
      {
        "id": "string",
        "value": "\"\ndestring ultfoc, replace\nreplace ultfoc=783 if ultfoc==.\ngen for=(ultfoc~=783)\nge usa = (ultfoc==805)\n*/\n\n* Introduce 2003 changes in sic codes\nreplace sic_lu= 27350 if year>=2003 & sic_lu[_n-1]==27350 & sic_lu==27100\nreplace sic_lu= 40200 if year>=2003 & (sic_lu==40210 |sic_lu==40220)\nreplace sic_lu= 51650 if year>=2003 & (sic_lu==51860 |sic_lu==51870)\nreplace sic_lu= 52482 if year>=2003 & sic_lu==52487 \nreplace sic_lu= 63120 if year>=2003 & (sic_lu==63121 |sic_lu==63122 | sic_lu==63123 | sic_lu==63129)\nreplace sic_lu= 66010 if year>=2003 & (sic_lu==66011 |sic_lu==66012)\nreplace sic_lu= 66030 if year>=2003 & (sic_lu==66031 |sic_lu==66032)\nreplace sic_lu= 72200 if year>=2003 & (sic_lu==72210 |sic_lu==72220)\nreplace sic_lu= 74119 if year>=2003 & (sic_lu==74112 |sic_lu==74113 | sic_lu==74119)\nge sic3=int(sic_lu/100)\n*ge sic3_ru=int(sic_ru/100)\n\n** Keep only if Local Unit is in Retail\n** Record if local unit in wholesale\nge sic2=int(sic_lu/1000)\nge wholesale=sic2==51\nbys ruref year: egen m_wholesale=max(whole)\nkeep if sic2==52\ndrop wholesale\n\n* Structure of retailer from LU file\n** Identify chains\ncap drop y\nge y=1\nbys ruref year: egen count_luref=count(y)\nge chain=(count_luref>1)\n\ncap drop type\ngen type_shop=.\nreplace type_shop =0 if chain==0\nreplace type_shop =1 if chain==1 & (count_luref<100)\nreplace type_shop =2 if chain==1 & count_luref>=100 & count_luref~=.\n\n** Note: a second definition of chains\n* Identify local, regional, national reporting units\nta ssr, ge(du_reg)\nforvalues y=1(1)11{\nbys ruref year: egen sum_du_reg`y'=sum(du_reg`y')\nreplace sum_du_reg`y'=1 if sum_du_reg`y'>0 & sum_du_reg`y'~=.\n}\negen count_reg=rowtotal(sum_du_reg*)\n\ngen type_nat=.\nreplace type_nat =0 if chain==0\nreplace type_nat =1 if chain==1 & (count_reg<9)\nreplace type_nat =2 if chain==1 & count_reg>=9 & count_reg~=.\n\n* Adjust problematic cases\nreplace type_nat=. if type_nat==0 & emp_lu>100 \nreplace type_shop=. if type_shop==0 & emp_lu>100 \ndrop y sum_du* du_reg*\n\n* Too many shops per ruref postcode\nge not_for_analysis=(ru_pcode_year>4 & ru_pcode_year~=.)\n\n* Jumps on emp growth of shop\ntsset luref year\nge emp_gro= (emp_lu-L1.emp_lu)/(0.5*(emp_lu+L1.emp_lu))\ncap drop outlier\nsu emp_gro,d\nge outlier=((emp_gro<=r(p1) | emp_gro>=r(p99)) & emp_lu~=. & emp_gro~=.)\n\nlabel var outlier \"",
        "line": 37,
        "column": 3044
      },
      {
        "id": "identifier",
        "value": "Jump",
        "line": 37,
        "column": 5340
      }
    ],
    "=": [
      {
        "id": "identifier",
        "value": "Indep",
        "line": 37,
        "column": 5489
      },
      {
        "id": "number",
        "value": "2",
        "line": 37,
        "column": 5498
      },
      {
        "id": "-",
        "value": "-",
        "line": 37,
        "column": 5499
      },
      {
        "id": "number",
        "value": "8",
        "line": 37,
        "column": 5500
      },
      {
        "id": "identifier",
        "value": "regions",
        "line": 37,
        "column": 5502
      },
      {
        "id": "number",
        "value": "9",
        "line": 37,
        "column": 5513
      },
      {
        "id": "-",
        "value": "-",
        "line": 37,
        "column": 5514
      },
      {
        "id": "number",
        "value": "10",
        "line": 37,
        "column": 5515
      },
      {
        "id": "identifier",
        "value": "regions",
        "line": 37,
        "column": 5518
      },
      {
        "id": "string",
        "value": "\"  \nlabel var type_shop     \"",
        "line": 37,
        "column": 5525
      },
      {
        "id": "number",
        "value": "0",
        "line": 37,
        "column": 5554
      },
      {
        "id": "identifier",
        "value": "Indep",
        "line": 37,
        "column": 5556
      },
      {
        "id": "number",
        "value": "2",
        "line": 37,
        "column": 5565
      },
      {
        "id": "-",
        "value": "-",
        "line": 37,
        "column": 5566
      },
      {
        "id": "number",
        "value": "99",
        "line": 37,
        "column": 5567
      },
      {
        "id": "identifier",
        "value": "shops",
        "line": 37,
        "column": 5570
      },
      {
        "id": "number",
        "value": "100",
        "line": 37,
        "column": 5579
      },
      {
        "id": "identifier",
        "value": "more",
        "line": 37,
        "column": 5583
      },
      {
        "id": "identifier",
        "value": "shops",
        "line": 37,
        "column": 5588
      },
      {
        "id": "string",
        "value": "\"  \nlabel var count_luref   \"",
        "line": 37,
        "column": 5593
      },
      {
        "id": "identifier",
        "value": "Number",
        "line": 37,
        "column": 5622
      },
      {
        "id": "identifier",
        "value": "of",
        "line": 37,
        "column": 5629
      },
      {
        "id": "identifier",
        "value": "shops",
        "line": 37,
        "column": 5632
      },
      {
        "id": "identifier",
        "value": "per",
        "line": 37,
        "column": 5638
      },
      {
        "id": "identifier",
        "value": "ruref",
        "line": 37,
        "column": 5642
      },
      {
        "id": "identifier",
        "value": "year",
        "line": 37,
        "column": 5648
      },
      {
        "id": "string",
        "value": "\"  \nlabel var imputed       \"",
        "line": 37,
        "column": 5652
      },
      {
        "id": "identifier",
        "value": "Jumps",
        "line": 37,
        "column": 5681
      },
      {
        "id": "number",
        "value": "1",
        "line": 37,
        "column": 5807
      }
    ],
    "if": [
      {
        "id": "identifier",
        "value": "the",
        "line": 37,
        "column": 5812
      },
      {
        "id": "identifier",
        "value": "local",
        "line": 37,
        "column": 5816
      },
      {
        "id": "identifier",
        "value": "unit",
        "line": 37,
        "column": 5822
      },
      {
        "id": "identifier",
        "value": "has",
        "line": 37,
        "column": 5827
      },
      {
        "id": "identifier",
        "value": "change",
        "line": 37,
        "column": 5831
      },
      {
        "id": "identifier",
        "value": "the",
        "line": 37,
        "column": 5838
      },
      {
        "id": "identifier",
        "value": "reporting",
        "line": 37,
        "column": 5842
      },
      {
        "id": "identifier",
        "value": "unit",
        "line": 37,
        "column": 5852
      },
      {
        "id": "identifier",
        "value": "at",
        "line": 37,
        "column": 5857
      },
      {
        "id": "identifier",
        "value": "some",
        "line": 37,
        "column": 5860
      },
      {
        "id": "identifier",
        "value": "point",
        "line": 37,
        "column": 5865
      },
      {
        "id": "identifier",
        "value": "of",
        "line": 37,
        "column": 5871
      },
      {
        "id": "identifier",
        "value": "its",
        "line": 37,
        "column": 5874
      },
      {
        "id": "identifier",
        "value": "history",
        "line": 37,
        "column": 5878
      },
      {
        "id": "string",
        "value": "\"\ndrop  m_postcode p1 m_p1 p0 m_p0 m_ruref\nsave \"",
        "line": 37,
        "column": 5885
      },
      {
        "id": "identifier",
        "value": "H",
        "line": 37,
        "column": 5934
      },
      {
        "id": ":",
        "value": ":",
        "line": 37,
        "column": 5935
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 5936
      },
      {
        "id": "identifier",
        "value": "Raffaella",
        "line": 37,
        "column": 5937
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 5946
      },
      {
        "id": "identifier",
        "value": "Retail",
        "line": 37,
        "column": 5947
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 5953
      },
      {
        "id": "identifier",
        "value": "Data",
        "line": 37,
        "column": 5954
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 5958
      },
      {
        "id": "identifier",
        "value": "luref_reg_ard2",
        "line": 37,
        "column": 5959
      },
      {
        "id": "string",
        "value": "\", replace\n\n******************************\n* Prepare for merge with regulation data\n******************************\nclear \nset mem 1000m\nuse \"",
        "line": 37,
        "column": 5973
      },
      {
        "id": "identifier",
        "value": "H",
        "line": 37,
        "column": 6114
      },
      {
        "id": ":",
        "value": ":",
        "line": 37,
        "column": 6115
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 6116
      },
      {
        "id": "identifier",
        "value": "Raffaella",
        "line": 37,
        "column": 6117
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 6126
      },
      {
        "id": "identifier",
        "value": "Retail",
        "line": 37,
        "column": 6127
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 6133
      },
      {
        "id": "identifier",
        "value": "Data",
        "line": 37,
        "column": 6134
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 6138
      },
      {
        "id": "identifier",
        "value": "luref_reg_ard2",
        "line": 37,
        "column": 6139
      },
      {
        "id": "string",
        "value": "\", replace\n\nlocal i=1 \nwhile `i'<=8{\ncap drop s`i'\ngen s`i'=substr(postcode,`i',1)\nta s`i', mis\nlocal i=`i'+1\n}\n\ngen t3=s3==\"",
        "line": 37,
        "column": 6153
      },
      {
        "id": "string",
        "value": "\"\ngen t4=s4==\"",
        "line": 37,
        "column": 6279
      },
      {
        "id": "string",
        "value": "\"\ngen t5=s5==\"",
        "line": 37,
        "column": 6294
      },
      {
        "id": "string",
        "value": "\"\n\ncap drop upos7\ngen upos7=s1+s2+s3+\"",
        "line": 37,
        "column": 6309
      },
      {
        "id": "string",
        "value": "\"+s4+s5+s6 if t3==1\nreplace upos7=s1+s2+s3+\"",
        "line": 37,
        "column": 6348
      },
      {
        "id": "string",
        "value": "\"+s5+s6+s7 if t4==1\nreplace upos7=s1+s2+s3+s4+s6+s7+s8 if t5==1\n\n\nlocal i=1 \nwhile `i'<=7{\ncap drop s`i'\ngen s`i'=substr(upos7,`i',1)\nta s`i', mis\nlocal i=`i'+1\n}\n\n* 372 only have sector postcode information\n\ndrop s1-s7 s8\nrename county lucounty\nsave \"",
        "line": 37,
        "column": 6393
      },
      {
        "id": "identifier",
        "value": "H",
        "line": 37,
        "column": 6645
      },
      {
        "id": ":",
        "value": ":",
        "line": 37,
        "column": 6646
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 6647
      },
      {
        "id": "identifier",
        "value": "Raffaella",
        "line": 37,
        "column": 6648
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 6657
      },
      {
        "id": "identifier",
        "value": "Retail",
        "line": 37,
        "column": 6658
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 6664
      },
      {
        "id": "identifier",
        "value": "Data",
        "line": 37,
        "column": 6665
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 6669
      },
      {
        "id": "identifier",
        "value": "luref_reg1_ard2",
        "line": 37,
        "column": 6670
      },
      {
        "id": "string",
        "value": "\", replace\n\ncompress\ndrop mode_r yd  t3 t4 t5 sic2\n\nsort upos7\nmerge upos7 using \"",
        "line": 37,
        "column": 6685
      },
      {
        "id": "identifier",
        "value": "H",
        "line": 37,
        "column": 6767
      },
      {
        "id": ":",
        "value": ":",
        "line": 37,
        "column": 6768
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 6769
      },
      {
        "id": "identifier",
        "value": "Raffaella",
        "line": 37,
        "column": 6770
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 6779
      },
      {
        "id": "identifier",
        "value": "Retail",
        "line": 37,
        "column": 6780
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 6786
      },
      {
        "id": "identifier",
        "value": "Data",
        "line": 37,
        "column": 6787
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 6791
      },
      {
        "id": "identifier",
        "value": "afpd05_reduced.dta",
        "line": 37,
        "column": 6792
      },
      {
        "id": "string",
        "value": "\"\nta _merge\n\n* Impute location for missing values\ngen po4=substr(upos7,1,4)\n\ntostring county, gen(nc)\nreplace nc=\"",
        "line": 37,
        "column": 6810
      },
      {
        "id": "number",
        "value": "09",
        "line": 37,
        "column": 6924
      },
      {
        "id": "string",
        "value": "\" if county==9\nreplace nc=\"",
        "line": 37,
        "column": 6926
      },
      {
        "id": "number",
        "value": "00",
        "line": 37,
        "column": 6953
      },
      {
        "id": "string",
        "value": "\" if county==0\ncap drop myladua\ngen myladua=nc+ladua\negen mfmyladua=mode(myladua), by(po4) \n\n* 2 missing values generated\negen mnorth=mean(north), by(po4)\negen meast=mean(east), by(po4)\n\nreplace east=meast if east==.\nreplace north=mnorth if north==.\nreplace myladua=mfmyladua if myladua==\"",
        "line": 37,
        "column": 6955
      },
      {
        "id": "identifier",
        "value": ".",
        "line": 37,
        "column": 7244
      },
      {
        "id": "string",
        "value": "\"\n\ndrop if _merge==2\ncount if myladua==\"",
        "line": 37,
        "column": 7245
      },
      {
        "id": "identifier",
        "value": ".",
        "line": 37,
        "column": 7285
      },
      {
        "id": "string",
        "value": "\"\n\n* don't know with 549 remaining cases - drop for now\ndrop if myladua==\"",
        "line": 37,
        "column": 7286
      },
      {
        "id": "identifier",
        "value": ".",
        "line": 37,
        "column": 7360
      },
      {
        "id": "string",
        "value": "\"\nrename myladua la_code\ndrop _m\ncap drop v\ndrop  mnorth meast po4 mfmy \n\n* Merge with ONS file to get la_names\nso la_code\nmerge la_code using  \"",
        "line": 37,
        "column": 7361
      },
      {
        "id": "identifier",
        "value": "H",
        "line": 37,
        "column": 7506
      },
      {
        "id": ":",
        "value": ":",
        "line": 37,
        "column": 7507
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 7508
      },
      {
        "id": "identifier",
        "value": "Raffaella",
        "line": 37,
        "column": 7509
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 7518
      },
      {
        "id": "identifier",
        "value": "Retail",
        "line": 37,
        "column": 7519
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 7525
      },
      {
        "id": "identifier",
        "value": "Data",
        "line": 37,
        "column": 7526
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 7530
      },
      {
        "id": "identifier",
        "value": "la_code2.dta",
        "line": 37,
        "column": 7531
      },
      {
        "id": "string",
        "value": "\"\nta _m\n* Drop 205: Northern Ireland\nkeep if _m==3\ndrop _m\nsave \"",
        "line": 37,
        "column": 7543
      },
      {
        "id": "identifier",
        "value": "H",
        "line": 37,
        "column": 7608
      },
      {
        "id": ":",
        "value": ":",
        "line": 37,
        "column": 7609
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 7610
      },
      {
        "id": "identifier",
        "value": "Raffaella",
        "line": 37,
        "column": 7611
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 7620
      },
      {
        "id": "identifier",
        "value": "Retail",
        "line": 37,
        "column": 7621
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 7627
      },
      {
        "id": "identifier",
        "value": "Data",
        "line": 37,
        "column": 7628
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 7632
      },
      {
        "id": "identifier",
        "value": "merge_new_pcodes_a_ard2",
        "line": 37,
        "column": 7633
      },
      {
        "id": "string",
        "value": "\", replace\n\n**********************\n* BUILD RAW DATA \n**********************\n/* Just recode to then get la aggregates*/\nclear\nset mem 1000m\nuse \"",
        "line": 37,
        "column": 7656
      },
      {
        "id": "identifier",
        "value": "H",
        "line": 37,
        "column": 7800
      },
      {
        "id": ":",
        "value": ":",
        "line": 37,
        "column": 7801
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 7802
      },
      {
        "id": "identifier",
        "value": "Raffaella",
        "line": 37,
        "column": 7803
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 7812
      },
      {
        "id": "identifier",
        "value": "Retail",
        "line": 37,
        "column": 7813
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 7819
      },
      {
        "id": "identifier",
        "value": "Data",
        "line": 37,
        "column": 7820
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 7824
      },
      {
        "id": "identifier",
        "value": "merge_new_pcodes_a_ard2",
        "line": 37,
        "column": 7825
      },
      {
        "id": "string",
        "value": "\", clear\n* Replace zero emp with miss, then interpolate\nreplace emp_lu=. if emp_lu==0\n\n* Replace missing employment with linear interpolation \nso luref year\nbys luref: ipolate emp_lu year, ge (emp2)\nreplace emp_lu=emp2 if emp_lu==. & emp2~=.\n\n* These are shops that could not be interpolated, drop?\nge miss=(emp_lu==.)\nbys luref: egen m=max(miss)\nta m\n\ndrop if m==1\ndrop m\ndrop  temp nc ladua  var1\nsave \"",
        "line": 37,
        "column": 7848
      },
      {
        "id": "identifier",
        "value": "H",
        "line": 37,
        "column": 8253
      },
      {
        "id": ":",
        "value": ":",
        "line": 37,
        "column": 8254
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 8255
      },
      {
        "id": "identifier",
        "value": "Raffaella",
        "line": 37,
        "column": 8256
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 8265
      },
      {
        "id": "identifier",
        "value": "Retail",
        "line": 37,
        "column": 8266
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 8272
      },
      {
        "id": "identifier",
        "value": "Data",
        "line": 37,
        "column": 8273
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 8277
      },
      {
        "id": "identifier",
        "value": "data_nov_ard2",
        "line": 37,
        "column": 8278
      },
      {
        "id": "string",
        "value": "\", replace\n\n\n* Collapse all info at the ruref level\n* Look at rurefs that have implausible changes in their stores\nuse \"",
        "line": 37,
        "column": 8291
      },
      {
        "id": "identifier",
        "value": "H",
        "line": 37,
        "column": 8411
      },
      {
        "id": ":",
        "value": ":",
        "line": 37,
        "column": 8412
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 8413
      },
      {
        "id": "identifier",
        "value": "Raffaella",
        "line": 37,
        "column": 8414
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 8423
      },
      {
        "id": "identifier",
        "value": "Retail",
        "line": 37,
        "column": 8424
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 8430
      },
      {
        "id": "identifier",
        "value": "Data",
        "line": 37,
        "column": 8431
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 8435
      },
      {
        "id": "identifier",
        "value": "data_nov_ard2",
        "line": 37,
        "column": 8436
      },
      {
        "id": "string",
        "value": "\", clear\ngen n_stay   =1    if  exit==1\ngen n_entry  =1    if  exit==2\ngen n_exit   =1    if  exit==3\ngen n_oney   =1    if  exit==4\nge g=1\ncollapse (sum) n_* g, by(ruref year)\ntsset ruref year\nsave \"",
        "line": 37,
        "column": 8449
      },
      {
        "id": "identifier",
        "value": "H",
        "line": 37,
        "column": 8649
      },
      {
        "id": ":",
        "value": ":",
        "line": 37,
        "column": 8650
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 8651
      },
      {
        "id": "identifier",
        "value": "Raffaella",
        "line": 37,
        "column": 8652
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 8661
      },
      {
        "id": "identifier",
        "value": "Retail",
        "line": 37,
        "column": 8662
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 8668
      },
      {
        "id": "identifier",
        "value": "Data",
        "line": 37,
        "column": 8669
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 8673
      },
      {
        "id": "identifier",
        "value": "ruref_year_ard2",
        "line": 37,
        "column": 8674
      },
      {
        "id": "string",
        "value": "\", replace\n\n\nu \"",
        "line": 37,
        "column": 8689
      },
      {
        "id": "identifier",
        "value": "H",
        "line": 37,
        "column": 8705
      },
      {
        "id": ":",
        "value": ":",
        "line": 37,
        "column": 8706
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 8707
      },
      {
        "id": "identifier",
        "value": "Raffaella",
        "line": 37,
        "column": 8708
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 8717
      },
      {
        "id": "identifier",
        "value": "Retail",
        "line": 37,
        "column": 8718
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 8724
      },
      {
        "id": "identifier",
        "value": "Data",
        "line": 37,
        "column": 8725
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 8729
      },
      {
        "id": "identifier",
        "value": "ruref_year_ard2",
        "line": 37,
        "column": 8730
      },
      {
        "id": "string",
        "value": "\", replace\nforeach var in entry exit oney stay{\nreplace n_`var' =. if year==1997 | year==2004\ncap drop delta_`var'\nge delta_`var' =(n_`var'-L1.n_`var')/L1.n_`var'\n}\nge delta_s = (g-L1.g)/L1.g\n*su delta_s,d\n\n* Nor mark just firms that have jump in stores\n* By inspection this seems to be a reporting omission\n* Now mark firms that have significant changes in the deltas (>100)\ngen prob=(delta_s>100 & delta_s~=.)\nbys ruref : egen m_prob=max(prob)\n\n* 271 firms jumping in number of stores (probably stores not recorded before) \n* Recode entry as missing when record starts (or all fake entry otherwise)\nso ruref year\nli ruref year g delta* n_* if m_prob==1\nkeep ruref year m_prob  \nlabel var m_prob \"",
        "line": 37,
        "column": 8745
      },
      {
        "id": "identifier",
        "value": "Jumps",
        "line": 37,
        "column": 9443
      }
    ],
    "in": [
      {
        "id": "identifier",
        "value": "shops",
        "line": 37,
        "column": 5348
      },
      {
        "id": "identifier",
        "value": "employment",
        "line": 37,
        "column": 5354
      },
      {
        "id": "string",
        "value": "\"\nlabel var not_          \"",
        "line": 37,
        "column": 5364
      },
      {
        "id": "identifier",
        "value": "To",
        "line": 37,
        "column": 5391
      },
      {
        "id": "identifier",
        "value": "drop",
        "line": 37,
        "column": 5394
      },
      {
        "id": "identifier",
        "value": "market",
        "line": 37,
        "column": 5402
      },
      {
        "id": "identifier",
        "value": "by",
        "line": 37,
        "column": 5409
      },
      {
        "id": "identifier",
        "value": "market",
        "line": 37,
        "column": 5412
      },
      {
        "id": "identifier",
        "value": "analysis",
        "line": 37,
        "column": 5419
      },
      {
        "id": "-",
        "value": "-",
        "line": 37,
        "column": 5428
      },
      {
        "id": "identifier",
        "value": "too",
        "line": 37,
        "column": 5430
      },
      {
        "id": "identifier",
        "value": "many",
        "line": 37,
        "column": 5434
      },
      {
        "id": "identifier",
        "value": "shops",
        "line": 37,
        "column": 5439
      },
      {
        "id": "identifier",
        "value": "one",
        "line": 37,
        "column": 5448
      },
      {
        "id": "identifier",
        "value": "postcode",
        "line": 37,
        "column": 5452
      },
      {
        "id": "string",
        "value": "\"\nlabel var type_nat      \"",
        "line": 37,
        "column": 5460
      },
      {
        "id": "number",
        "value": "0",
        "line": 37,
        "column": 5487
      },
      {
        "id": "identifier",
        "value": "luref",
        "line": 37,
        "column": 5690
      },
      {
        "id": "identifier",
        "value": "across",
        "line": 37,
        "column": 5696
      },
      {
        "id": "identifier",
        "value": "years",
        "line": 37,
        "column": 5703
      },
      {
        "id": "string",
        "value": "\"\nlabel var ru_pcode_year \"",
        "line": 37,
        "column": 5708
      },
      {
        "id": "identifier",
        "value": "Number",
        "line": 37,
        "column": 5735
      },
      {
        "id": "identifier",
        "value": "of",
        "line": 37,
        "column": 5742
      },
      {
        "id": "identifier",
        "value": "shops",
        "line": 37,
        "column": 5745
      },
      {
        "id": "identifier",
        "value": "per",
        "line": 37,
        "column": 5751
      },
      {
        "id": "identifier",
        "value": "ruref",
        "line": 37,
        "column": 5755
      },
      {
        "id": "identifier",
        "value": "postcode",
        "line": 37,
        "column": 5761
      },
      {
        "id": "identifier",
        "value": "year",
        "line": 37,
        "column": 5770
      },
      {
        "id": "string",
        "value": "\"\nlabel var change_ru     \"",
        "line": 37,
        "column": 5774
      },
      {
        "id": "identifier",
        "value": "Dummy",
        "line": 37,
        "column": 5801
      },
      {
        "id": "identifier",
        "value": "number",
        "line": 37,
        "column": 9452
      },
      {
        "id": "identifier",
        "value": "of",
        "line": 37,
        "column": 9459
      },
      {
        "id": "identifier",
        "value": "stores",
        "line": 37,
        "column": 9462
      },
      {
        "id": "identifier",
        "value": "per",
        "line": 37,
        "column": 9469
      },
      {
        "id": "identifier",
        "value": "firm",
        "line": 37,
        "column": 9473
      },
      {
        "id": "string",
        "value": "\"\nso ruref year\nsave \"",
        "line": 37,
        "column": 9477
      },
      {
        "id": "identifier",
        "value": "H",
        "line": 37,
        "column": 9499
      },
      {
        "id": ":",
        "value": ":",
        "line": 37,
        "column": 9500
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 9501
      },
      {
        "id": "identifier",
        "value": "Raffaella",
        "line": 37,
        "column": 9502
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 9511
      },
      {
        "id": "identifier",
        "value": "Retail",
        "line": 37,
        "column": 9512
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 9518
      },
      {
        "id": "identifier",
        "value": "Data",
        "line": 37,
        "column": 9519
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 9523
      },
      {
        "id": "identifier",
        "value": "ruref_year_probs_ard2",
        "line": 37,
        "column": 9524
      },
      {
        "id": "string",
        "value": "\",replace\n\n\n* Merge back into main data file the dummies to identify problems\n* Note: here I am cleaning only for single stores with excessive employment\n* Arbitrary set to 100\n\nuse \"",
        "line": 37,
        "column": 9545
      },
      {
        "id": "identifier",
        "value": "H",
        "line": 37,
        "column": 9728
      },
      {
        "id": ":",
        "value": ":",
        "line": 37,
        "column": 9729
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 9730
      },
      {
        "id": "identifier",
        "value": "Raffaella",
        "line": 37,
        "column": 9731
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 9740
      },
      {
        "id": "identifier",
        "value": "Retail",
        "line": 37,
        "column": 9741
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 9747
      },
      {
        "id": "identifier",
        "value": "Data",
        "line": 37,
        "column": 9748
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 9752
      },
      {
        "id": "identifier",
        "value": "data_nov_ard2",
        "line": 37,
        "column": 9753
      },
      {
        "id": "string",
        "value": "\", clear\nso ruref year\nmmerge ruref year using \"",
        "line": 37,
        "column": 9766
      },
      {
        "id": "identifier",
        "value": "H",
        "line": 37,
        "column": 9814
      },
      {
        "id": ":",
        "value": ":",
        "line": 37,
        "column": 9815
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 9816
      },
      {
        "id": "identifier",
        "value": "Raffaella",
        "line": 37,
        "column": 9817
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 9826
      },
      {
        "id": "identifier",
        "value": "Retail",
        "line": 37,
        "column": 9827
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 9833
      },
      {
        "id": "identifier",
        "value": "Data",
        "line": 37,
        "column": 9834
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 9838
      },
      {
        "id": "identifier",
        "value": "ruref_year_probs_ard2",
        "line": 37,
        "column": 9839
      },
      {
        "id": "string",
        "value": "\"\nta _m\ndrop _m\n\n* Generate marker to clean level dataset\nbys luref : egen m_not=max(not_)\nge drop_lev=(m_not==1 | m_prob==1)\nbys luref: egen m_drop_lev=max(drop_lev)\nta m_drop_l\ndrop if m_drop_l==1\ndrop m_drop_l\n\n* Problems for non realistic independent stores (more than a 100 people now)\nbys luref: egen m_cha=max(chain)\nge pro=(m_cha==0 & emp_lu>100 & emp_lu~=.)\n\n* Drop them if they fall in this category (location is ambiguous)\nbys luref: egen g=max(pro)\ndrop if g==1\n\n* Recode as chains others (but remember to include then=m below)\nreplace chain=1 if (m_cha==1 & emp_lu>100 & emp_lu~=.)\nsave \"",
        "line": 37,
        "column": 9860
      },
      {
        "id": "identifier",
        "value": "H",
        "line": 37,
        "column": 10461
      },
      {
        "id": ":",
        "value": ":",
        "line": 37,
        "column": 10462
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 10463
      },
      {
        "id": "identifier",
        "value": "Raffaella",
        "line": 37,
        "column": 10464
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 10473
      },
      {
        "id": "identifier",
        "value": "Retail",
        "line": 37,
        "column": 10474
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 10480
      },
      {
        "id": "identifier",
        "value": "Data",
        "line": 37,
        "column": 10481
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 10485
      },
      {
        "id": "identifier",
        "value": "data_nov1_ard2",
        "line": 37,
        "column": 10486
      },
      {
        "id": "string",
        "value": "\", replace\n\n\n* This is to build definition of firm according to median firm level employment\nclear\nset mem 800m\nuse \"",
        "line": 37,
        "column": 10500
      },
      {
        "id": "identifier",
        "value": "H",
        "line": 37,
        "column": 10617
      },
      {
        "id": ":",
        "value": ":",
        "line": 37,
        "column": 10618
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 10619
      },
      {
        "id": "identifier",
        "value": "Raffaella",
        "line": 37,
        "column": 10620
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 10629
      },
      {
        "id": "identifier",
        "value": "Retail",
        "line": 37,
        "column": 10630
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 10636
      },
      {
        "id": "identifier",
        "value": "Data",
        "line": 37,
        "column": 10637
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 10641
      },
      {
        "id": "identifier",
        "value": "data_nov1_ard2",
        "line": 37,
        "column": 10642
      },
      {
        "id": "string",
        "value": "\", clear\nbys ruref year: egen ruref_emp=sum(emp_lu)\nbys ruref year: egen n_shop=count(luref)\nso ruref year\ndrop if ruref==ruref[_n-1] & year==year[_n-1]\nkeep sic3 ruref year ruref_emp n_shop chain\nge type_alt=.\nreplace type_alt=0 if chain==0\nreplace type_alt=1 if (chain==1 & n_shop<=100)\nreplace type_alt=2 if (chain==1 & n_shop>100 & n_shop~=.)\n\n* Define position on firm in emp distrbution\nbys sic3 type_alt: egen m_emp=median(ruref_emp)\n* Define shops according to firm charact\nge d_1=(type_alt==0 & ruref_emp<=m_emp)\nge d_2=(type_alt==0 & ruref_emp>m_emp & ruref_emp~=.)\nge d_3=(type_alt==1 & ruref_emp<=m_emp)\nge d_4=(type_alt==1 & ruref_emp>m_emp & ruref_emp~=.)\nge d_5=(type_alt==2 & ruref_emp<=m_emp)\nge d_6=(type_alt==2 & ruref_emp>m_emp & ruref_emp~=.)\nso ruref year sic3\nsave \"",
        "line": 37,
        "column": 10656
      },
      {
        "id": "identifier",
        "value": "H",
        "line": 37,
        "column": 11445
      },
      {
        "id": ":",
        "value": ":",
        "line": 37,
        "column": 11446
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 11447
      },
      {
        "id": "identifier",
        "value": "Raffaella",
        "line": 37,
        "column": 11448
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 11457
      },
      {
        "id": "identifier",
        "value": "Retail",
        "line": 37,
        "column": 11458
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 11464
      },
      {
        "id": "identifier",
        "value": "Data",
        "line": 37,
        "column": 11465
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 11469
      },
      {
        "id": "identifier",
        "value": "data_nov1_ruref_ard2",
        "line": 37,
        "column": 11470
      },
      {
        "id": "string",
        "value": "\", replace\n\n\n*  MERGE BACK AGAIN INTO STORES DATA\nclear\nset mem 800m\nuse \"",
        "line": 37,
        "column": 11490
      },
      {
        "id": "identifier",
        "value": "H",
        "line": 37,
        "column": 11564
      },
      {
        "id": ":",
        "value": ":",
        "line": 37,
        "column": 11565
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 11566
      },
      {
        "id": "identifier",
        "value": "Raffaella",
        "line": 37,
        "column": 11567
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 11576
      },
      {
        "id": "identifier",
        "value": "Retail",
        "line": 37,
        "column": 11577
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 11583
      },
      {
        "id": "identifier",
        "value": "Data",
        "line": 37,
        "column": 11584
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 11588
      },
      {
        "id": "identifier",
        "value": "data_nov1_ard2",
        "line": 37,
        "column": 11589
      },
      {
        "id": "string",
        "value": "\", clear\ncompress\nkeep type_nat gor m_not luref ruref year outlier not_ imputed emp_lu chain count_reg sic3 la_code count_luref\nmmerge ruref year using \"",
        "line": 37,
        "column": 11603
      },
      {
        "id": "identifier",
        "value": "H",
        "line": 37,
        "column": 11756
      },
      {
        "id": ":",
        "value": ":",
        "line": 37,
        "column": 11757
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 11758
      },
      {
        "id": "identifier",
        "value": "Raffaella",
        "line": 37,
        "column": 11759
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 11768
      },
      {
        "id": "identifier",
        "value": "Retail",
        "line": 37,
        "column": 11769
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 11775
      },
      {
        "id": "identifier",
        "value": "Data",
        "line": 37,
        "column": 11776
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 11780
      },
      {
        "id": "identifier",
        "value": "data_nov1_ruref_ard2",
        "line": 37,
        "column": 11781
      },
      {
        "id": "string",
        "value": "\"\nkeep if _m==3\ndrop _m\n\nge ok=sic3==521\nbys luref: egen m=max(ok)\nkeep if m==1\nreplace sic3=521\n\n* Generate types\ngen type=.\nreplace type=1 if d_1==1 | d_2==1\nreplace type=2 if d_3==1 | d_4==1\nreplace type=3 if d_5==1 | d_6==1\n\ngen type2=.\nreplace type2=1 if d_1==1 \nreplace type2=2 if d_2==1\nreplace type2=3 if d_3==1 | d_4==1\nreplace type2=4 if d_5==1 | d_6==1\nsave \"",
        "line": 37,
        "column": 11801
      },
      {
        "id": "identifier",
        "value": "H",
        "line": 37,
        "column": 12171
      },
      {
        "id": ":",
        "value": ":",
        "line": 37,
        "column": 12172
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 12173
      },
      {
        "id": "identifier",
        "value": "Raffaella",
        "line": 37,
        "column": 12174
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 12183
      },
      {
        "id": "identifier",
        "value": "Retail",
        "line": 37,
        "column": 12184
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 12190
      },
      {
        "id": "identifier",
        "value": "Data",
        "line": 37,
        "column": 12191
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 12195
      },
      {
        "id": "identifier",
        "value": "prel",
        "line": 37,
        "column": 12196
      },
      {
        "id": "string",
        "value": "\", replace\n*/\n\n\n**** Note: file prel.dta manually copied over into this directory\ncd \"",
        "line": 37,
        "column": 12200
      },
      {
        "id": "identifier",
        "value": "T",
        "line": 37,
        "column": 12286
      },
      {
        "id": ":",
        "value": ":",
        "line": 37,
        "column": 12287
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 12288
      },
      {
        "id": "identifier",
        "value": "LSE",
        "line": 37,
        "column": 12289
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 12292
      },
      {
        "id": "identifier",
        "value": "Raffaella_Sadun",
        "line": 37,
        "column": 12293
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 12308
      },
      {
        "id": "identifier",
        "value": "_Papers",
        "line": 37,
        "column": 12309
      },
      {
        "id": "identifier",
        "value": "Replication",
        "line": 37,
        "column": 12317
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 12328
      },
      {
        "id": "identifier",
        "value": "Retail",
        "line": 37,
        "column": 12329
      },
      {
        "id": "\\",
        "value": "\\",
        "line": 37,
        "column": 12335
      },
      {
        "id": "identifier",
        "value": "data",
        "line": 37,
        "column": 12336
      },
      {
        "id": "string",
        "value": "\"\n\n***************\n** CHAINS DEFINITIONS\n***************\nu \"",
        "line": 37,
        "column": 12340
      },
      {
        "id": "identifier",
        "value": "prel",
        "line": 37,
        "column": 12400
      },
      {
        "id": "string",
        "value": "\", replace\nkeep emp_lu ruref luref year sic3 not_ la_code type*  gor count_reg\ngen x=1\n\n* This is to identify types of chains\nbys ruref year: egen a=sum(emp_lu)\nbys ruref: egen am=mean(a)\nbys year: egen a1=sum(emp)\nbys ruref year: egen b=sum(x)\nbys ruref: egen bm=mean(b)\nbys year: egen b1=sum(x)\ndrop x\n\n* Identify very large stores\nbys luref: egen max_e=max(emp_lu)\ndrop type_alt* type\nrename type2 type\nta type, ge (type_)\n\n* These are stores that remain independent\ncap drop pro\nge pro=(type==1 | type==2)\nreplace pro=2 if type==3\nreplace pro=3 if type==4\n\n* Here need to fix type of stores over time\ncap drop m2 m3\nbys luref: egen m2=max(pro)\nbys luref: egen m3=min(pro)\ncap drop indep\nge indep=((m2==m3) & (pro==1))\n\n* These are indep that become parts of chains\nge switch=(m3==1 & m2~=1)\nge chain=(m2~=1 & m3~=1)\n\n* count regions\nso ruref gor \nbys ruref: ge n_gor=gor!=gor[_n-1]\nbys ruref: egen count_reg2=sum(n_gor)\nsave  \"",
        "line": 37,
        "column": 12404
      },
      {
        "id": "identifier",
        "value": "chains_sept12",
        "line": 37,
        "column": 13335
      },
      {
        "id": "string",
        "value": "\", replace\n\nu  \"",
        "line": 37,
        "column": 13348
      },
      {
        "id": "identifier",
        "value": "chains_sept12",
        "line": 37,
        "column": 13364
      },
      {
        "id": "string",
        "value": "\", replace\nbys ruref year: egen c_max=max(count_reg)\ngen check=.\nreplace check=1 if indep==1\nreplace check=2 if switch==1\nreplace check=3 if indep==0 & switch==0\ngen very_large=emp_lu>1000 if emp_lu!=.\n\n* Step 1: Define store size based on employment\n* 28 is median emp of national chain stores in before 2000 (excluded) - use this as benchmark for all\nge small_all=28\nge size=.\nreplace size = 1 if emp_lu<small_all  & check==3\nreplace size = 2 if emp_lu>=small_all & emp_lu~=.  & check==3\n\n* Step 2: Define national retail chains\n* Employment cutoff\ngen firm1=.\nreplace firm1=1 if  a<=10000 & check==3\nreplace firm1=2 if  a>10000 & check==3\n\n* Number of regions\ngen firm3=.\nreplace firm3=1 if  count_reg<10 &check==3\nreplace firm3=2 if  count_reg>=10 &check==3\n\n* This defines which cutoff is used\nge firm=1 if (firm1==1 | firm1==1) & check==3\nreplace firm=2 if (firm1==2 & firm1==2) & check==3\n\n/* \n* run to create file to be merged with other store types info\nkeep luref year firm size emp_lu la_code \nso luref year\nsave luref_type, replace\n*/\n\ndrop type*\nge t_new=.\nreplace t_new=1 if firm==1 & size==1 & check==3\nreplace t_new=2 if firm==1 & size==2 & check==3\nreplace t_new=3 if firm==2 & size==1 & check==3\nreplace t_new=4 if firm==2 & size==2 & check==3\ngen aa1=1\nta t_new, ge(tt)\nta firm, ge(ff)\nta size, ge(ss)\ntab check, gen(cc)\nso luref year\nsa  \"",
        "line": 37,
        "column": 13377
      },
      {
        "id": "identifier",
        "value": "chains_sept12_precollapse",
        "line": 37,
        "column": 14736
      },
      {
        "id": "string",
        "value": "\", replace\n\n**************\n* FROM NOW ON TO CREATE LOCAL AUTHORITY AGGREGATES\n*************\nu  \"",
        "line": 37,
        "column": 14761
      },
      {
        "id": "identifier",
        "value": "chains_sept12_precollapse",
        "line": 37,
        "column": 14857
      },
      {
        "id": "string",
        "value": "\", replace\n* Keep only chain and independent stores (exclude switchers for simplicity)\ndrop if check==2\n\nforeach var of varlist aa1 tt* ff* ss* cc*{\ncap drop agg_shop_`var'\ncap drop emp`var'0 \ncap drop agg_emp_`var'\nbys la_code year: egen agg_shop_`var'=sum(`var')\ngen emp`var'0 = emp_lu if `var'==1\nbys la_code year: egen agg_emp_`var'=sum(emp`var'0)\ncap drop emp`var'0 \n}\n\n* LA wide stats\nbys la_code year: egen m_very_large=max(very_large)\nso la_code year\ndrop if la_code==la_code[_n-1]& year==year[_n-1] \nkeep la_code year agg_*   m_very*\nforeach var in aa1 tt1 tt2 tt3 tt4  ff1 ff2 ss1 ss2 cc1 cc3{\nso la_code year\nbys la_code: gen delta_emp_`var'=ln(1+agg_emp_`var')-ln(1+agg_emp_`var'[_n-1])\n}\nso la_code year \nsave  \"",
        "line": 37,
        "column": 14882
      },
      {
        "id": "identifier",
        "value": "datachains_sept12_v1",
        "line": 37,
        "column": 15607
      },
      {
        "id": "string",
        "value": "\", replace\n",
        "line": 37,
        "column": 15627
      }
    ],
    "options": [
      {
        "id": "number",
        "value": "1",
        "line": 37,
        "column": 5496
      },
      {
        "id": "number",
        "value": "2",
        "line": 37,
        "column": 5511
      },
      {
        "id": "number",
        "value": "1",
        "line": 37,
        "column": 5563
      },
      {
        "id": "number",
        "value": "2",
        "line": 37,
        "column": 5577
      }
    ]
  }
]